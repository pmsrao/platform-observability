{
  "datasets": {
    "total_cost_summary": {
      "name": "dataset_001",
      "displayName": "Total Cost Summary",
      "queryLines": [
        "WITH cost_summary AS (",
        "  SELECT ",
        "    SUM(list_cost_usd) as total_cost_usd,",
        "    COUNT(DISTINCT workspace_key) as active_workspaces,",
        "    COUNT(DISTINCT entity_key) as active_entities,",
        "    AVG(list_cost_usd) as avg_daily_cost ",
        "  FROM platform_observability.plt_gold.gld_fact_usage_priced_day ",
        "  WHERE date_key >= date_format(date_sub(current_date(), 30), 'yyyyMMdd') ",
        ") ",
        "SELECT ",
        "  'Total Cost (30 days)' as metric,",
        "  CONCAT('$', FORMAT_NUMBER(total_cost_usd, 2)) as value,",
        "  'USD' as unit ",
        "FROM cost_summary ",
        "UNION ALL ",
        "SELECT ",
        "  'Active Workspaces' as metric,",
        "  CAST(active_workspaces AS STRING) as value,",
        "  'count' as unit ",
        "FROM cost_summary ",
        "UNION ALL ",
        "SELECT ",
        "  'Active Entities' as metric,",
        "  CAST(active_entities AS STRING) as value,",
        "  'count' as unit ",
        "FROM cost_summary ",
        "UNION ALL ",
        "SELECT ",
        "  'Avg Daily Cost' as metric,",
        "  CONCAT('$', FORMAT_NUMBER(avg_daily_cost, 2)) as value,",
        "  'USD/day' as unit ",
        "FROM cost_summary "
      ]
    },
    "cost_trend": {
      "name": "dataset_002",
      "displayName": "Cost Trend",
      "queryLines": [
        "SELECT ",
        "  date_key,",
        "  SUM(list_cost_usd) as daily_cost_usd,",
        "  AVG(SUM(list_cost_usd)) OVER (ORDER BY date_key ROWS 6 PRECEDING) as rolling_7day_avg ",
        "FROM platform_observability.plt_gold.gld_fact_usage_priced_day ",
        "WHERE date_key >= date_format(date_sub(current_date(), 30), 'yyyyMMdd') ",
        "GROUP BY date_key ",
        "ORDER BY date_key "
      ]
    },
    "top_cost_centers": {
      "name": "dataset_003",
      "displayName": "Top Cost Centers",
      "queryLines": [
        "SELECT ",
        "  cost_center,",
        "  line_of_business,",
        "  SUM(list_cost_usd) as total_cost_usd,",
        "  COUNT(DISTINCT entity_key) as active_entities,",
        "  ROUND(try_divide(SUM(list_cost_usd), COUNT(DISTINCT entity_key)), 2) as cost_per_entity ",
        "FROM platform_observability.plt_gold.gld_fact_usage_priced_day ",
        "WHERE date_key >= date_format(date_sub(current_date(), 30), 'yyyyMMdd') ",
        "  AND cost_center != 'unallocated' ",
        "GROUP BY cost_center, line_of_business ",
        "ORDER BY total_cost_usd DESC ",
        "LIMIT 10 "
      ]
    },
    "runtime_health": {
      "name": "dataset_004",
      "displayName": "Runtime Health",
      "queryLines": [
        "WITH runtime_health AS (",
        "  SELECT ",
        "    c.dbr_version,",
        "    COUNT(DISTINCT c.cluster_key) as cluster_count,",
        "    SUM(f.list_cost_usd) as total_cost,",
        "    CASE ",
        "      WHEN c.dbr_version LIKE '%13.%' THEN 'Current' ",
        "      WHEN c.dbr_version LIKE '%12.%' THEN 'Recent' ",
        "      WHEN c.dbr_version LIKE '%11.%' THEN 'Older' ",
        "      ELSE 'Legacy' ",
        "    END as version_category ",
        "  FROM platform_observability.plt_gold.gld_fact_usage_priced_day f ",
        "  JOIN platform_observability.plt_gold.gld_dim_cluster c ON f.cluster_key = c.cluster_key ",
        "  WHERE f.date_key >= date_format(date_sub(current_date(), 30), 'yyyyMMdd') ",
        "    AND c.is_current = true ",
        "  GROUP BY c.dbr_version, version_category ",
        ") ",
        "SELECT ",
        "  version_category,",
        "  COUNT(*) as runtime_versions,",
        "  SUM(cluster_count) as total_clusters,",
        "  SUM(total_cost) as total_cost_usd ",
        "FROM runtime_health ",
        "GROUP BY version_category ",
        "ORDER BY ",
        "  CASE version_category ",
        "    WHEN 'Current' THEN 1 ",
        "    WHEN 'Recent' THEN 2 ",
        "    WHEN 'Older' THEN 3 ",
        "    ELSE 4 ",
        "  END "
      ]
    },
    "monthly_cost_breakdown": {
      "name": "dataset_005",
      "displayName": "Monthly Cost Breakdown",
      "queryLines": [
        "SELECT ",
        "  DATE_FORMAT(TO_DATE(CAST(date_key AS STRING), 'yyyyMMdd'), 'yyyy-MM') as month,",
        "  cost_center,",
        "  line_of_business,",
        "  SUM(list_cost_usd) as total_cost_usd,",
        "  COUNT(DISTINCT entity_key) as active_entities,",
        "  ROUND(try_divide(SUM(list_cost_usd), COUNT(DISTINCT entity_key)), 2) as cost_per_entity ",
        "FROM platform_observability.plt_gold.gld_fact_usage_priced_day ",
        "WHERE cost_center != 'unallocated' ",
        "  AND date_key >= date_format(date_sub(current_date(), 90), 'yyyyMMdd') ",
        "GROUP BY DATE_FORMAT(TO_DATE(CAST(date_key AS STRING), 'yyyyMMdd'), 'yyyy-MM'), cost_center, line_of_business ",
        "ORDER BY month DESC, total_cost_usd DESC "
      ]
    },
    "job_performance_analysis": {
      "name": "dataset_006",
      "displayName": "Job Performance Analysis",
      "queryLines": [
        "SELECT ",
        "  e.name as job_name,",
        "  e.workspace_name,",
        "  COUNT(DISTINCT f.job_run_id) as total_runs,",
        "  AVG(f.duration_hours) as avg_duration_hours,",
        "  SUM(f.list_cost_usd) as total_cost_usd,",
        "  ROUND(try_divide(SUM(f.list_cost_usd), COUNT(DISTINCT f.job_run_id)), 2) as cost_per_run ",
        "FROM platform_observability.plt_gold.gld_fact_usage_priced_day f ",
        "JOIN platform_observability.plt_gold.gld_dim_entity e ON f.entity_key = e.entity_key ",
        "WHERE f.date_key >= date_format(date_sub(current_date(), 30), 'yyyyMMdd') ",
        "  AND e.is_current = true ",
        "  AND e.entity_type IN ('JOB', 'PIPELINE') ",
        "GROUP BY e.name, e.workspace_name ",
        "HAVING COUNT(DISTINCT f.job_run_id) >= 5 ",
        "ORDER BY total_cost_usd DESC ",
        "LIMIT 15 "
      ]
    },
    "filter_parameters": {
      "name": "dataset_007",
      "displayName": "Filter Parameters",
      "queryLines": [
        "SELECT ",
        "  DISTINCT workspace_name ",
        "FROM platform_observability.plt_gold.gld_dim_workspace ",
        "WHERE status = 'ACTIVE' ",
        "ORDER BY workspace_name "
      ]
    }
  }
}
